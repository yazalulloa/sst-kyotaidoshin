<div class="flex flex-col gap-2 overflow-hidden"
     x-data="{
 counter: 0
}">
  <div class="flex flex-row gap-0 justify-center font-extrabold capitalize">
    <span x-text="$t('main-title-extra-charges')"></span>:&nbsp;<span x-text="counter"></span>
  </div>

  <div class="md:grid md:grid-cols-[7fr_3fr] flex flex-col gap-4 justify-center"
       x-data="{
      is_edit: false,
      buildingKey: '',
      key: '',

      description: '',
      amount: '',
      active: true,
      currency: '',

      select_all: false,
      apartmentsSelected: [],

      descriptionErr: '',
      amountErr: '',
      errMsg: ''
             }"
       @event-extra-charge-form-update.window="
         let base64 = $event.detail.params;
         let decodedString = atob(base64);
         let jsonObject = JSON.parse(decodedString);

          is_edit = true;
          key = jsonObject.key;
          description = jsonObject.description;
          amount = jsonObject.amount;
          active = jsonObject.active;
          currency = jsonObject.currency;
          apartmentsSelected = jsonObject.apts;

     "
       @event-extra-charge-form-restart-after-deletion="
              let v = $event.detail?.key?.trim();
              if (v && v === key) {
                $dispatch('event-extra-charge-form-reset');
                $dispatch('event-extra-charge-form-clean-errors');
              }
             "
       @event-extra-charge-form-clean-errors="
              errMsg = '';
              descriptionErr = '';
              amountErr = '';
             "
       @event-extra-charge-form-reset="
              description = '';
              amount = '';
              active = true;
              apartmentsSelected = [];
              select_all = false;
              is_edit = false;
              key = buildingKey;
              errMsg = '';
              descriptionErr = '';
              amountErr = '';
             ">

    <div class="flex flex-col gap-0">
      <div class="font-bold grid grid-cols-[2fr_1fr_3fr_1fr] border-b border-surface-dark dark:border-surface dark:text-surface">
        <span x-text="$t('main-title-description')"></span>
        <span x-text="$t('main-title-amount')"></span>
        <span x-text="$t('main-title-apartments')"></span>
        <span x-text="$t('main-title-actions')"></span>
      </div>
      <ol id="extra-charges-list"
          class="*:grid *:grid-cols-[2fr_1fr_3fr_1fr] *:gap-2 *:p-2 *:items-center *:text-center *:border-b *:border-surface-dark *:dark:border-surface *:dark:text-surface">

      </ol>
    </div>

    <form id="extra-charges-form"
          class="relative top-0 flex h-fit flex-col gap-2"
          x-init="scrollThroughParent($el)"
          hx-put="/api/extraCharges"
          hx-indicator=".htmx-indicator"
          hx-target="#extra-charges-form-error"
          hx-swap="innerHTML"
          hx-disabled-elt="this, #extra-charges-form * > input:not([disabled]), #extra-charges-form * > button:not([disabled]), #extra-charges-form * > select:not([disabled])">


      <div id="extra-charges-form-error" hidden="hidden"></div>

      <input hidden="hidden" name="key" x-model="key">

      <div class="flex w-full flex-col gap-1 text-on-surface dark:text-on-surface-dark">
        <label for="extraChargeDescriptionInput"
               x-bind:class="descriptionErr !== '' ? 'text-danger' : ''"
               class="flex w-fit items-center gap-1 pl-0.5 text-sm">
          <svg x-show="descriptionErr !== ''" x-bind:data-src="crossIcon" data-cache="21600" class="size-4"></svg>
          <span x-text="$t('main-title-description')"></span>
        </label>
        <input
            id="extraChargeDescriptionInput"
            type="text"
            class="w-full rounded-radius border bg-surface-alt px-2 py-2 text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:cursor-not-allowed disabled:opacity-75 dark:bg-surface-dark-alt/50 dark:focus-visible:outline-primary-dark"
            name="description"
            maxlength="100"
            x-model="description"
            x-bind:class="descriptionErr !== '' ? 'border-danger' : 'order-outline dark:border-outline-dark'"
            x-init="
          trimInput($el);
          limitInputToMaxLength($el);
          "
            required
        />
        <small x-model="descriptionErr"
               x-bind:class="descriptionErr !== '' ? 'text-danger' : ''"
               class="text-start pl-0.5">
        </small>
      </div>

      <div class="flex w-full flex-col gap-1 text-on-surface dark:text-on-surface-dark">
        <label for="extraChargesAmountInput"
               x-bind:class="amountErr !== '' ? 'text-danger' : ''"
               class="flex w-fit items-center gap-1 pl-0.5 text-sm">

          <svg x-show="amountErr !== ''" x-bind:data-src="crossIcon" data-cache="21600" class="size-4"></svg>
          <span x-text="$t('main-title-amount')"></span>
        </label>
        <input
            id="extraChargesAmountInput"
            class="w-full rounded-radius border bg-surface-alt px-2 py-2 text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:cursor-not-allowed disabled:opacity-75 dark:bg-surface-dark-alt/50 dark:focus-visible:outline-primary-dark"
            type="number"
            name="amount"
            maxlength="14"
            step=".01"
            x-model="amount"
            x-bind:class="amountErr !== '' ? 'border-danger' : 'order-outline dark:border-outline-dark'"
            x-init="
            limitInputToMaxLength($el)
            configureCurrencyInput($el)
            "
            required
        />
        <small x-model="amountErr"
               x-bind:class="amountErr !== '' ? 'text-danger' : ''"
               class="text-start pl-0.5">
        </small>
      </div>

      <div class="grid grid-cols-[1fr_3fr] gap-2">
        <label for="extraChargesActive"
               class="flex items-center gap-2 text-sm font-medium text-on-surface dark:text-on-surface-dark has-checked:text-on-surface-strong dark:has-checked:text-on-surface-dark-strong has-disabled:cursor-not-allowed has-disabled:opacity-75">
          <div class="relative flex items-center">
            <input id="extraChargesActive"
                   type="checkbox"
                   name="active"
                   x-model="active"
                   value="true"
                   class="before:content[''] peer relative size-4 appearance-none overflow-hidden rounded-sm border border-outline bg-surface-alt before:absolute before:inset-0 checked:border-primary checked:before:bg-primary focus:outline-2 focus:outline-offset-2 focus:outline-outline-strong checked:focus:outline-primary active:outline-offset-0 disabled:cursor-not-allowed dark:border-outline-dark dark:bg-surface-dark-alt dark:checked:border-primary-dark dark:checked:before:bg-primary-dark dark:focus:outline-outline-dark-strong dark:checked:focus:outline-primary-dark"/>
            <svg x-bind:data-src="checkBoxIcon" data-cache="21600"></svg>
          </div>
          <span x-text="$t('main-title-active')"></span>
        </label>

        <div class="relative flex w-full flex-col gap-1 text-on-surface dark:text-on-surface-dark">
          <label for="extraChargesCurrencySelect" class="w-fit pl-0.5 text-sm"
                 x-text="$t('main-title-currency')"></label>
          <svg x-bind:data-src="selectIcon" data-cache="21600"></svg>
          <select id="extraChargesCurrencySelect"
                  name="currency"
                  x-model="currency"
                  class="w-full appearance-none rounded-radius border border-outline bg-surface-alt px-4 py-2 text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:cursor-not-allowed disabled:opacity-75 dark:border-outline-dark dark:bg-surface-dark-alt/50 dark:focus-visible:outline-primary-dark">
            <template x-for="value in currencies">
              <option x-bind:value="value" x-text="value"></option>
            </template>
          </select>
          <small></small>
        </div>

      </div>

      <div x-bind:hx-get="apartmentsSelectorPartialUrl"
           hx-trigger="load"
           hx-swap="outerHTML"
           hx-target="this"
           hidden="hidden">
      </div>

      <p x-show="errMsg !== ''" x-text="errMsg" class="text-danger border border-danger"></p>

      <div class="flex flex-row gap-2 justify-start">
        <button
            x-text="is_edit ? $t('main-action-update') : $t('main-action-create')"
            x-effect="
             $el.disabled=!(description?.trim()?.length > 0 && parseFloat(amount) > 0 && apartmentsSelected.length > 0)
            "
            class="whitespace-nowrap rounded-radius bg-primary border border-primary px-4 py-2 text-sm font-medium tracking-wide text-on-primary transition hover:opacity-75 text-center focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary active:opacity-100 active:outline-offset-0 disabled:opacity-75 disabled:cursor-not-allowed dark:bg-primary-dark dark:border-primary-dark dark:text-on-primary-dark dark:focus-visible:outline-primary-dark"
            @click="
              let form = document.getElementById('extra-charges-form');
              form.classList.remove('border', 'border-success')
              errMsg = '';
            ">
        </button>
        <button type="button"
                class="whitespace-nowrap rounded-radius bg-surface-alt border border-surface-alt px-4 py-2 text-sm font-medium tracking-wide text-on-surface-strong transition hover:opacity-75 text-center focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-surface-alt active:opacity-100 active:outline-offset-0 disabled:opacity-75 disabled:cursor-not-allowed dark:bg-surface-dark-alt dark:border-surface-dark-alt dark:text-on-surface-dark-strong dark:focus-visible:outline-surface-dark-alt"
                @click.prevent="$dispatch('event-extra-charge-form-reset')"
                x-text="$t('main-action-clear')">
        </button>
      </div>
    </form>

  </div>

</div>