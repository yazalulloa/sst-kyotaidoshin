<div id="header-container" hx-swap-oob="true"
     class="flex flex-col items-center text-center fade-me-out fade-me-in">

  <div id="receipts-email-progress" class="flex flex-col gap-0 w-full items-center text-center">
  </div>

  <div class="flex w-full flex-row flex-wrap items-center justify-start gap-2 text-center"
       x-data="{
  buildings: []
  }">

    <div class="flex flex-row justify-center text-center items-center gap-2 min-w-[7rem]"
         x-data="{
   total: null,
   query: null
  }">
      <div id="receipts-counters" hidden="hidden"></div>

      <div x-show="total" class="flex flex-row gap-0">
        <span x-text="$t('main-title-receipts')"></span><span>:&nbsp;</span><span x-text="total"></span>
      </div>
      <div x-show="query" class="flex flex-row gap-0">
        <span x-text="$t('main-title-items')"></span><span>:&nbsp;</span><span x-text="query"></span>
      </div>
    </div>

    <div x-data="{
        formId: 'receipt-upload-backup',
        uploadFormPath: '/api/receipts/uploadBackupForm',
        uploadFileCallback: '/api/receipts/upload/backup',
        callBackSwap: 'innerHTML',
        btnText: 'main-action-upload-backup',
        fileAccept: '.json.gz'
       }">
      <div hidden="hidden"
           x-bind:hx-get="uploadFormPartialUrl"
           hx-trigger="load"
           hx-swap="outerHTML">
      </div>
    </div>

    <div
        data-change-element="receipts-updater"
        data-change-event="update-receipts">

      <div hidden="hidden"
           hx-get="/api/receipts/buildingsIds"
           hx-trigger="load"
           hx-swap="outerHTML">
      </div>

      <div x-bind:hx-get="apartmentsBuildingSelectorPartialUrl"
           hx-trigger="load"
           hx-swap="outerHTML"
           hidden="hidden">
        <input name="building_input"/>
      </div>
    </div>

    <div
        data-change-element="receipts-updater"
        data-change-event="update-receipts"
        x-data="{
      monthsSelected: []
      }">

      <div x-bind:hx-get="monthsSelectorPartialUrl"
           hx-trigger="load"
           hx-swap="outerHTML"
           hidden="hidden">
        <input name="month_input"/>
      </div>
    </div>

    <div
        data-change-element="receipts-updater"
        data-change-event="update-receipts"
        x-data="{
   years: []
  }"
    >

      <div hx-get="/api/receipts/years"
           hx-trigger="load"
           hx-swap="outerHTML"
           hidden="hidden">
      </div>

      <div x-bind:hx-get="receiptYearsSelectorPartialUrl"
           hx-trigger="load"
           hx-swap="outerHTML"
           hidden="hidden">
        <input name="year_input"/>
      </div>
    </div>

    <div id="receipts-updater"
         hidden="hidden"
         hx-get="/api/receipts/search"
         hx-trigger="load, update-receipts delay:300ms, new-apt"
         hx-include="[name='building_input'],[name='month_input'],[name='year_input']"
         hx-target="#receipts-table"
         hx-swap="innerHTML"
         hx-sync="this:replace"
         hx-indicator=".htmx-indicator">
    </div>


    <button type="button"
            class="whitespace-nowrap border bg-transparent px-4 py-2 text-center text-sm font-medium tracking-wide transition rounded-radius border-secondary text-secondary hover:opacity-75 focus-visible:outline-secondary focus-visible:outline-2 focus-visible:outline-offset-2 active:opacity-100 active:outline-offset-0 disabled:cursor-not-allowed disabled:opacity-75 dark:border-secondary-dark dark:text-secondary-dark dark:focus-visible:outline-secondary-dark"
            x-text="$t('main-action-delete-pdfs')"
            hx-delete="/api/receipts/clear_pdfs"
            hx-indicator=".htmx-indicator"
            hx-disabled-elt="this"
            hx-trigger="click"
            hx-swap="none">
    </button>


    <form
        x-data="{
            url: '',
            file: '',
          }"
        x-init="
            $watch('file', (value) => {
              if (value && value !== '') {
               if (false) {
               $el.firstElementChild.dispatchEvent(new CustomEvent('get_form'))
               }

              }
            })
            $watch('url', (value) => {
              htmx.process($el)
              if (value) {
                $el.dispatchEvent(new CustomEvent('send_file'));
              }
            })
          "
        @event-handle-request="
          file = ''
          url = ''

          if ($event.detail.status === 204) {
          $el.children[1].dispatchEvent(new CustomEvent('upload'))
          } else {
           //todo show toast
          console.log('Response', $event.detail)
          }

          $el.firstElementChild.innerHTML = ''

        "
        id="uploader-receipt"
        class="whitespace-nowrap bg-transparent rounded-radius border border-secondary px-4 py-2 text-sm font-medium tracking-wide text-secondary transition hover:opacity-75 text-center focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-secondary active:opacity-100 active:outline-offset-0 disabled:opacity-75 disabled:cursor-not-allowed dark:border-secondary-dark dark:text-secondary-dark dark:focus-visible:outline-secondary-dark"
        x-bind:hx-post="url"
        hx-encoding="multipart/form-data"
        hx-disabled-elt="this, #uploader-receipt * > input:not([disabled]), #uploader-receipt * > label:not([disabled])"
        hx-swap="outerHTML"
        hx-trigger="send_file"
        hx-indicator=".htmx-indicator"
        hx-params="not filename"
        hx-on::after-request="
        if (event.srcElement.id === this.id) {
         this.dispatchEvent(new CustomEvent('event-handle-request', { detail: event.detail.xhr}))
        }
        "
    >


      <div
          hx-get="/api/receipts/upload_form"
          hx-trigger="get_form"
          hx-disabled-elt="this, #uploader-receipt * > input:not([disabled]), #uploader-receipt * > label:not([disabled])"
          hx-vals="js:{ name: event.detail}"
          hx-swap="innerHTML"
          hidden="hidden">
      </div>

      <div hx-post="/api/receipts/new_from_file"
           hx-trigger="upload"
           hx-disabled-elt="this, #uploader-receipt * > input:not([disabled]), #uploader-receipt * > label:not([disabled])"
           hx-params="key"
           hx-swap="none"
           hidden="hidden">
      </div>

      <label
          class="flex flex-row gap-0"
          x-data="{ filename: ''}"
      >
        <span x-text="$t('main-action-upload-receipt')"></span>
        <span x-show="filename !== ''">:&nbsp;</span>
        <span
            x-bind:class="filename === '' ? 'hidden' : ''"
            x-text="filename"
            x-init="$watch('file', (value) => {
            if (value && value.length > 0) {
              filename = $el.nextElementSibling.files[0].name;
              $el.parentElement.parentElement.firstElementChild.dispatchEvent(new CustomEvent('get_form', { detail: filename}))
             } else {
              filename = '';
             }
          })"
        ></span>
        <input
            class="hidden"
            type="file"
            accept=".xlsx"
            name="file"
            x-model="file"
        />
      </label>

    </form>

  </div>

  <div x-bind:hx-get="receiptNewDialogPartialUrl"
       hx-trigger="load"
       hx-swap="outerHTML"
       hidden="hidden">
  </div>
</div>

<div id="container" hx-swap-oob="true">
  <ul id="receipts-table"
      class="flex flex-col *:p-1 *:md:grid *:md:grid-cols-[1fr_1fr_1fr_1fr_1fr_2fr_1fr] *:md:gap-2 *:flex *:flex-row *:flex-wrap *:gap-4 *:items-center *:text-center *:border-b *:border-surface-dark *:dark:border-surface *:dark:text-surface *:hover:text-on-surface-strong *:dark:hover:bg-primary-dark/5 *:dark:hover:text-on-surface-dark-strong">

  </ul>

</div>